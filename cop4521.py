import time
import json
from os import environ as env
from urllib.parse import quote_plus, urlencode

from authlib.integrations.flask_client import OAuth
from dotenv import find_dotenv, load_dotenv
from flask import Flask, redirect, render_template, session, url_for
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

from app import Config 

ENV_FILE = find_dotenv()
if ENV_FILE:
    load_dotenv(ENV_FILE)

app = Flask(__name__)
app.secret_key = env.get("APP_SECRET_KEY")

app.config.from_object(Config)

db = SQLAlchemy(app)
migrate = Migrate(app, db)

from app import models
#u = User(username='brian', email='example@ex.com')
#print(u)


oauth = OAuth(app)

oauth.register(
    "auth0",
    client_id=env.get("AUTH0_CLIENT_ID"),
    client_secret=env.get("AUTH0_CLIENT_SECRET"),
    client_kwargs={
        "scope": "openid profile email",
    },
    server_metadata_url=f'https://{env.get("AUTH0_DOMAIN")}/.well-known/openid-configuration'
)

@app.route("/")
def index():
    #to_return = "<img src='/static/images/stars.jpg' alt='no image found'>"
    #image_url = url_for('memes', filename='spongebob-leak.gif')
    image_url = '/memes/spongebob-leak.gif'
    to_return = "<img src='%s' alt='no image found!!'>" % (image_url)
    session_user = dict(session).get('user', None)
    if (session_user):
        to_return = to_return + "<p>User {} is logged in</p>".format(session_user["userinfo"]["name"])
    return '<p>This is a Python Flask app running with Gunicorn and Nginx! ğŸ+ğŸ§ª+ğŸ¦„+ğŸš™ = âš¡ï¸ğŸ’ªğŸ”¥</p>' + to_return + image_url

@app.route("/home")
def home():
    return render_template("home.html", session=dict(session).get('user', None)) 

from app.auth import auth_bp 
app.register_blueprint(auth_bp)

if __name__ == "__main__":
	app.run(host='0.0.0.0')
